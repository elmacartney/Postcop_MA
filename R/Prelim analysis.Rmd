---
title: "Post-cop trait on paternity"
author: "Erin Macartney"
date: '2023-01-10'
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE,
cache = TRUE, 
tidy = TRUE, 
echo = TRUE
)

rm(list = ls())
```

# Setting up {.tabset}

## Loading packages
```{r, message = FALSE}

# devtools::install_github('Mikata-Project/ggthemr', force = TRUE)

# if (!require("BiocManager", quietly = TRUE))
# install.packages("BiocManager")
# 
# BiocManager::install(version = '3.16')
# BiocManager::install("ggtree", force = TRUE)

#TODO still can't get ggtree to work with the most up to date version of R and Rstudio. It will occasionally run then stop running again. 

eval(metafor:::.MuMIn)

pacman::p_load(dplyr,
               tidyr,
               # tidyverse,
               readr,
               here, 
               metafor, 
               clubSandwich, 
               orchaRd,
               rotl,
               ape,
               tibble,
               phytools,
               ggplot2,
               ggsignif,
               ggtree,
               ggthemr,
               ggtreeExtra,
               ggalluvial,
               patchwork,
               clubSandwich,
               MuMIn)
```

## Loading data and functions
```{r, message = FALSE}
#Code for loading raw data
# dat <- read_csv(here("Data", "Data_raw_crosschecked_variation recoded.csv")) #raw data was used for data processing below

# dat <- read_csv(here("Data", "processed_data2.csv"))
dat <- read_csv(here("Data", "processed_data3.csv"))
source(here("R/func.R")) #functions for converting other statistics into correlations
tree <- read.tree(here("R", "species_tree.tre")) #loading phylogenetic tree
```

## Calculating r

Note that this code runs on Data_raw_crosschecked.csv not Data_processed.csv
```{r, eval = FALSE}
effect_size_group2 <- with(dat, mapply(group2, 
                                       mean_low, mean_high, 
                                       SD_low, SD_high, 
                                       n_low, n_high))


#only selecting study that reported mean of for groups

# dat_a <- dat %>%
#   filter(First_author == "Yamane")

# effect_size_group4 <- with(dat_a, mapply(group4, 
#                                        mean_low, mean_med1, mean_med2, mean_high,
#                                        SD_low, SD_med1, SD_med2, SD_high,
#                                        n_low, n_med1, n_med2, n_high,
#                                        sim = 100000))

#manually added these correlations based on the function above


effect_size_est <- with(dat, mapply(est_se_b, estimate,SE, N))

effect_size_t <- with(dat, mapply(t_vals_b, t, N))

effect_size_F <- with(dat, mapply(F_vals_b, F, N, reverse = FALSE))

effect_size_p <- with(dat, mapply(p_vals_b, p, N, reverse = FALSE))


dat2 <- bind_cols(dat, "effect_size_group2" = effect_size_group2, 
                      "effect_size_est" =  effect_size_est, 
                      "effect_size_t" =  effect_size_t, 
                      "effect_size_F" = effect_size_F, 
                      "effect_size_p" = effect_size_p)

#removing unclear F stat direction
df2 <- subset(dat2, Effectsize_ID !='3')

#combining all r into one column

df3 <- df2 %>%
    select("Effectsize_ID","Corr_r", "effect_size_group2", 
    "effect_size_est","effect_size_t", "effect_size_F", "effect_size_p") %>% 
    pivot_longer(cols = -Effectsize_ID, values_to = "effect_size", names_to = "summary_statistic") %>% 
    drop_na() 

#merging back with df2

df4 <- merge(df3, df2, by = "Effectsize_ID")

# df2 %>% pivot_longer(cols = c("Corr_r", "effect_size_group2", "effect_size_est","effect_size_t", "effect_size_F", "effect_size_p"), values_to = "effect_size", names_to = "summary_statistic") %>% drop_na(effect_size)

#flipping effect size so that higher = better
df4$effect_size2<- ifelse(df4$Coin == 2, -df4$effect_size, df4$effect_size) 

# write.csv(df4, "processed_data.csv")

```

## Making species tree

```{r, eval = FALSE}

length(unique(df4$Species)) #34 species
unique(df4$Species)

taxa <- tnrs_match_names(unique(df4$Species))
table(taxa$approximate_match) #34

# mytree <- tol_induced_subtree(ott_ids = taxa$ott_id, label_format= "name")
#HTTP failure: 400 [/v3/tree_of_life/induced_subtree] Error: node_id 'ott3411771' was not found!list(ott3411771 = "pruned_ott_id")

taxa[taxa[["ott_id"]] == "3411771", ] #gryllus_bimaculatus 
df4$Species[df4$Species == "Gryllus_bimaculatus"]  <- "Gryllus_bimaculata"
df4$Species[df4$Species == "Xiphophorus_helleri"]  <- "Xiphophorus_hellerii"

taxa <- tnrs_match_names(unique(df4$Species))

mytree <- tol_induced_subtree(ott_ids = taxa$ott_id, label_format= "name") # comes up with warning about dropping singleton nodes

sort(setdiff(unique(df4$Species), as.character(mytree$tip.label))) #"Drosophila_melanogaster" "Gadus_morhua"            "Gryllus_bimaculata"      "Sus_domestica" "Coregonus_lavaretus"  "Cyprinus_carpio"  names not matching
#allocating drosophila melanogaster to wrong ottID
#changing names of other species

# plot(mytree, show.tip.label = T, cex = 0.8, no.margin = TRUE)

#allocating correct OTTID
inspect(taxa, taxon_name = "Drosophila_melanogaster")
taxa <- update(taxa, taxon_name = "Drosophila_melanogaster", new_row_number = 1)

inspect(taxa, taxon_name = "Cyprinus_carpio")
taxa <- update(taxa, taxon_name = "Cyprinus_carpio", new_row_number = 1)

inspect(taxa, taxon_name = "Coregonus_lavaretus")
taxa <- update(taxa, taxon_name = "Coregonus_lavaretus", new_row_number = 1)

mytree <- tol_induced_subtree(ott_ids = taxa$ott_id, label_format= "name")

df4$Species[df4$Species == "Gryllus_bimaculata"]  <- "Gryllus_bimaculatus"
# mytree <- tol_induced_subtree(ott_ids = taxa$ott_id, label_format= "name")

# changing tip labels
mytree$tip.label[mytree$tip.label == "Sus_scrofa_domesticus"]  <- "Sus_domestica"
mytree$tip.label[mytree$tip.label == "Gadus_morhua_(species_in_domain_Eukaryota)"]  <- "Gadus_morhua"

sort(setdiff(unique(df4$Species), as.character(mytree$tip.label))) # all names match

plot(mytree, show.tip.label = T, cex = 0.8, no.margin = TRUE)
str(mytree)

write.tree(mytree, file = "species_tree.tre")
```

## Calculating Zr and Variance

```{r, eval = FALSE}

# test
#df4 <- read_csv(here("Data", "processed_data.csv"))

# TODO - this was wrong - should be N/2 for dependent samples
#df4$N2 <- ifelse(df4$N_dependent == "dependent", df4$N, df4$N/2)
df4$N2 <- ifelse(df4$N_dependent == "dependent", df4$N/2, df4$N)
# TODO - 38th obs has N = 2.5 replacing with 3.5 (the smallest N in the dataset) - Erin 
#  the function did say the reason was that N was too small
df4$N2 <- ifelse(df4$N2 == 2.5, 3.5, df4$N2)

df5 <- escalc(measure = "ZCOR", ni = df4$N2, ri = df4$effect_size2, data = df4)

#adding back to dataframe 
#df5 <- bind_cols(df4, zr)

#write.csv(df5, "processed_data2.csv")
# new data with zr and variance
write.csv(df5, "processed_data3.csv")

```

manually having to calculate vi for effect sizes 39, 43 and 44 as for some reason the function isn't calculating it for these ones

# Data exploration {.tabset}

## Sample sizes

```{r, eval = FALSE}
# number of effect sizes

length(unique(dat$Effectsize_ID)) #note that effect_size2 has the effect size flipped so that higher = better
#why does data go down to 106 then?

#number of studies

length(unique(dat$Study_ID))

# number of animal groups

length(unique(dat$Group_ID))

# Publication year range

min(dat$Year_published)
max(dat$Year_published)

#number of species
length(unique(dat$Species))

#number of classes
length(unique(dat$Class))

#number of classes
dat %>%
  group_by(Class) %>%
  summarise(n = n_distinct(Study_ID))

#fertilisation mode
dat %>%
  group_by(Fertilisation_mode) %>%
  summarise(n = n_distinct(Effectsize_ID))

#traits
dat %>%
  group_by(PC_type) %>%
  summarise(n = n_distinct(Effectsize_ID))

# 69/(69+35)

# Cause of PC variation 

dat %>%
  group_by(PC_variation_cause2) %>%
  summarise(n = n_distinct(Effectsize_ID))

```

## Fig. 1

```{r}

sample_data <- count(dat, Species)
sample_data <- as.data.frame(sample_data)
sample_data2 <- mutate(sample_data, tip.label = Species)

# tree$tip.label <- strip_ott_ids(tree$tip.label, remove_underscores = TRUE)

sample_data3 <- left_join(sample_data2, dat[, c("Species", "Class")],
    by = "Species")

sample_data4 <- distinct(sample_data3, Species, .keep_all = TRUE)

# sample_data4$tip.label <- gsub('_',' ',sample_data4$tip.label)

sample_data4$Species <- as.character(sample_data4$Species)
sample_data4$tip.label <- as.character(sample_data4$tip.label)
sample_data4$Class <- as.factor(sample_data4$Class)

#prepare effect sizes counts data
sample_data4$Species <- sub('Xiphophorus_helleri','Xiphophorus_hellerii', sample_data4$Species) #fix typo
data_species_count_K <- sample_data4$n
names(data_species_count_K) <- sample_data4$Species #add row names

#prepare papers counts data
papers_counts <- dat %>% group_by(Species) %>% summarize(distinct_papers = n_distinct(Paper_ID)) %>% deframe() #using library(tibble)
names(papers_counts) <- sub('Xiphophorus_helleri','Xiphophorus_hellerii', names(papers_counts)) #fix typo
data_papers_count_N_tree <- papers_counts[match(tree$tip.label, names(papers_counts))]  # reorder counts to match the order of tips 

#prepare Class data
sample_data4$Class <- as.factor(sample_data4$Class)
#levels(sample_data4$Class)

#set colors (by Class) for the plot
color_bgroup <- c("#00A1D5", "#999933", "#A20056", "#E9AF1D", "#E18727", "#661100", "#117733")[sample_data4$Class] #assign colors to Class - based on levels(data_species_bgroup) #biological groups - https://r-charts.com/color-palettes/
names(color_bgroup) <- sample_data4$Species #make it a named vector
color_bgroup_tip <- color_bgroup[match(tree$tip.label, names(color_bgroup))]  # reorder colors to match the order of tips on the tree
data_species_count_K_tree <- data_species_count_K[match(tree$tip.label, names(data_species_count_K))]  # reorder counts to match the order of tips on the tree

#plot locally using base graphics
plot.new()
plot(tree, x.lim = 100, y.lim = length(sample_data4$Species)+2, cex = 1, tip.color = color_bgroup_tip, label.offset = 1, edge.color = "grey", font = 3)
phydataplot(data_species_count_K, tree, col = color_bgroup_tip, offset = 40, scaling = 2, border = "white", lwd = 3, legend = "side") #add counts of effect sizes bars 
text(90, length(sample_data4$Species)+2, "effect sizes (papers)", font=3) #add counts label
text(95, 1:length(data_species_count_K_tree), data_species_count_K_tree) #add counts of effect sizes numbers 
text(100, 1:length(data_papers_count_N_tree), paste("(", data_papers_count_N_tree, ")")) #add counts of effect sizes numbers 

#it is easy to add species silluettes (e.g. one per class) using library(rphylopic)


```


## Fig. 2

```{r,}
freq1 <- as.data.frame(table(dat$Fertilisation_mode, dat$PC_type, dat$PC_variation_cause2)) %>%
  rename("Fertilisation_mode" = Var1, "Trait" = Var2, "Variation_cause" = Var3)

levels(freq1$Fertilisation_mode) <- list("internal" = "1", "external" = "2")

levels(freq1$Trait) <- list("sperm number" = "1","testis size" = "2", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7", "accessory gland size" = "8")

levels(freq1$Variation_cause) <- list("natural" = "1", "environmental plasticity" = "2", "age" = "3", "direct manipulation" = "4", "genetic differences" = "5", "unclear/other" = "6")

Fig2 <- ggplot(data = freq1, aes(axis1 = Fertilisation_mode, axis2 = Trait, axis3 = Variation_cause, y = Freq)) +
    geom_alluvium(aes(fill = Fertilisation_mode)) + geom_flow() + geom_stratum(aes(fill = Fertilisation_mode)) +
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + geom_text(stat
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + =
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + "stratum",
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + aes(label
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + =
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + after_stat(stratum)))
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + +
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + #theme_minimal()
    geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + +
theme_void() + theme(legend.position = "none", plot.title = element_text(hjust = 0,
    vjust = 3), axis.title.x = element_text(), axis.text.x = element_text(face = "bold"),
    plot.margin = unit(c(1, 1, 0, 1), "cm")) + scale_x_discrete(limits = c("Fertilisation mode", "Postcopulatory trait", "Variation cause"), expand = c(0.15, 0.05), position = "top")

Fig2
```

```{r, eval=FALSE}
# freq1 <- as.data.frame(table(dat$Fertilisation_mode, dat$Competition_order, dat$PC_type, dat$PC_variation_cause)) %>%
#   rename("Fertilisation_mode" = Var1, "Mating_order" = Var2, "Trait" = Var3, "Variation_cause" = Var4)
# 
# levels(freq1$Fertilisation_mode) <- list("internal" = "1", "external" = "2")
# 
# levels(freq1$Mating_order) <- list("P1" = "1", "P2" = "2", "random mixing" = "3", "P1 and P2 (mating order controlled for)" = "4", "other/unclear" = "5")
# 
# levels(freq1$Trait) <- list("sperm number" = "1","testis size" = "2", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7", "accessory gland size" = "8")
# 
# levels(freq1$Variation_cause) <- list("natural" = "1", "environmental plasticity" = "2", "age" = "3", "direct manipulation" = "4", "artificial selcetion" = "5", "unclear/other" = "6")
# 
# Fig2a <- ggplot(data = freq1, aes(axis1 = Fertilisation_mode, axis2 = Mating_order, axis3 = Trait, axis4 = Variation_cause, y = Freq)) +
#     geom_alluvium(aes(fill = Fertilisation_mode)) + geom_flow() + geom_stratum(aes(fill = Fertilisation_mode)) +
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + geom_text(stat
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + =
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + "stratum",
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + aes(label
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + =
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + after_stat(stratum)))
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + +
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + #theme_minimal()
#     geom_text(stat = "stratum", aes(label = after_stat(stratum))) + #theme_minimal() + +
# theme_void() + theme(legend.position = "none", plot.title = element_text(hjust = 0,
#     vjust = 3), axis.title.x = element_text(), axis.text.x = element_text(face = "bold"),
#     plot.margin = unit(c(1, 1, 0, 1), "cm")) + scale_x_discrete(limits = c("Fertilisation mode", "Mating order", "Postcopulatory trait", "Variation cause"), expand = c(0.15, 0.05), position = "top")
```


# Analysis {.tabset}

## Global effect size

```{r}

dat$Species[dat$Species == "Gryllus_bimaculata"]  <- "Gryllus_bimaculatus"

dat$Species[dat$Species == "Xiphophorus_helleri"]  <- "Xiphophorus_hellerii"

dat$Phylogeny <- gsub('_',' ',dat$Species)
tree$tip.label<- gsub('_',' ',tree$tip.label)


 # sort(setdiff(unique(dat$Phylogeny), as.character(tree$tip.label))) 
```

```{r, eval = FALSE}
branchlength<- compute.brlen(tree, method="Grafen", power=1)
VCV_species <- vcv(branchlength, corr=TRUE)


VCV <- impute_covariance_matrix(vi = dat$vi, cluster = dat$Study_ID, r = 0.5)

# data <- dat %>%
#   select(Study_ID, Effectsize_ID, Species, yi, vi)
# complete.cases(data)        


m0 <- rma.mv(yi = yi, V = VCV, 
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             data = dat)

summary(m0, transfm = "tanh") #TODO is the working?? values are the same. 

round(i2_ml(m0), 2) #both species and phylo = 0% variation

# m0b <- rma.mv(yi = yi, V = VCV, random = list(~1|Study_ID,
#                                             ~1|Effectsize_ID),
#                                             #~1|Species,
#                                             #~1|Phylogeny),
#              #R=list(Phylogeny = VCV_species),
#              data = dat)
# 
# # summary(m0b)
# # 
#  anova(m0b, m0) # reduced model as slightly lower ARC (delta = 4)


```

### Fig. 3
```{r}

# TODO - this is how you get Correlation rather than Zr
# Also a few other things changed
res0 <- mod_results(m0, mod = "1", data = dat, group = "Study_ID")
# not quite sure why these do not work
#res0$mod_table$name <- "Overall"
#res0$data$moderator <- rep("Overall", each = nrow(res0$data))
Fig3 <- orchard_plot(res0, mod = "1", xlab = "Correlation (r)", 
                    group = "Study_ID", alpha=0.4, transfm = "tanh") +
  scale_colour_manual(values = c("grey34")) +
  scale_fill_manual(values=c("grey34")) 

# #TODO previous code to modify oarchard plot no longer works
  # chaning y name to "Overall effect size"
  # geom_errorbarh(data = res0, aes(xmin = lowerPR, xmax = upperPR), 
  #     height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) +
  # geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), 
  #     height = 0.05, show.legend = FALSE, size = 2)　+
  # geom_point(aes(fill = name), shape = 21)+
  # scale_size_continuous(range = c(1, 7))+
  # theme(panel.border = element_rect(colour = "black", fill=NA))

# #TODO previous code to modify oarchard plot no longer works

Fig3
```

## Meta-regression {.tabset}

### Traits

```{r, message = FALSE}

#removing trait 2 (testes size)

dat1 <- subset(dat, PC_type !=2)

dat1$PC_type<-as.factor(dat1$PC_type)

VCV1 <- impute_covariance_matrix(vi = dat1$vi, cluster = dat1$Study_ID, r = 0.5)

levels(dat1$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7")
                    

m1 <- rma.mv(yi = yi, V = VCV1, mod = ~PC_type-1,  
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             test = "t",
             data = dat1)


summary(m1)

r2_ml(m1)

res1 <- mod_results(m1, mod = "PC_type", data = dat1, group = "Study_ID")

fig.4a <- orchard_plot(res1 , mod = "PC_type", group = "Study_ID", data = dat1, xlab = "Correlation (r)", alpha=0.4, transfm = "tanh") +
  theme(axis.text.y = element_text(angle = 45)) +
  ggtitle('Post-copulatory trait as a moderator in global model') +
    geom_signif(comparisons = list(c("Seminal fluid quantity", "Total ejaculate size", "Sperm normality", "Sperm velocity", "Sperm length", "Sperm number")),
              annotations = "*")

# fig.4a

```


### Internal vs external fertilisation

```{r, message = FALSE}

dat$Fertilisation_mode<-as.factor(dat$Fertilisation_mode)

levels(dat$Fertilisation_mode) <- list("internal" = "1", "external" = "2")

m4 <- rma.mv(yi = yi, V = VCV, mod = ~Fertilisation_mode-1,  
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             test = "t",
             data = dat)

summary(m4)

r2_ml(m4)

res2 <- mod_results(m4, mod = "Fertilisation_mode", data = dat, group = "Study_ID")

fig.4b <- orchard_plot(res2, mod = "Fertilisation_mode", group = "Study_ID", data = dat, xlab = "Correlation (r)", alpha=0.4, transfm = "tanh")+
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34"))  +
  theme(axis.text.y = element_text(angle = 45)) +
  ggtitle('Fertilisation mode as a moderator in global model') +
    geom_signif(comparisons = list(c("Internal", "External")),
              annotations = "*")

```


```{r, eval = FALSE}
##### Combined fert mode and trait
# 
# dat$Fert_trait <- paste(dat$Fertilisation_mode, dat$PC_type, sep = " ")
# 
# m4c <- rma.mv(yi = yi, V = VCV, mod = ~Fert_trait-1,  
#              random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat)
# 
# summary(m4c)
# 
# fig.5c <- orchard_plot(m4c, mod = "Fert_trait", group = "Study_ID", data = dat, xlab = "zr", alpha=0.4)+
#   theme(axis.text.y = element_text(angle = 45)) 
# 
# fig.5c
```

#### Internal sub-analysis

```{r}

dat3 <- subset(dat, Fertilisation_mode == "internal")

dat3 <- subset(dat3, PC_type !=2)

VCV3 <- impute_covariance_matrix(vi = dat3$vi, cluster = dat3$Study_ID, r = 0.5)


dat3$PC_type<-as.factor(dat3$PC_type)

levels(dat3$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7", "accessory gland size" = "8")
levels(dat3$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7")


m4a <- rma.mv(yi = yi, V = VCV3, mod = ~PC_type-1,  
              random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             test = "t",
             data = dat3)

summary(m4a)
r2_ml(m4a)

res3 <- mod_results(m4a, mod = "PC_type", data = dat3, group = "Study_ID")

fig.4c <- orchard_plot(res3, mod = "PC_type", group = "Study_ID", data = dat3, xlab = "Correlation (r)", alpha=0.4, transfm = "tanh")+ ylim(-1,1) +
  theme(axis.text.y = element_text(angle = 45)) +
  ggtitle('Post-copulatory traits within internal fertilisers') +
    geom_signif(comparisons = list(c("Seminal fluid quantity", "Total ejaculate size", "Sperm normality", "Sperm velocity", "Sperm length", "Sperm number")),
              annotations = "*")
```

#### External sub-analysis

```{r}
dat4 <- subset(dat, Fertilisation_mode == "external")

dat4 <- subset(dat4, PC_type !=2)

VCV4 <- impute_covariance_matrix(vi = dat4$vi, cluster = dat4$Study_ID, r = 0.5)


dat4$PC_type<-as.factor(dat4$PC_type)

levels(dat4$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7")


m4b <- rma.mv(yi = yi, V = VCV4, mod = ~PC_type-1,  
              random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             test = "t",
             data = dat4)

summary(m4b)
r2_ml(m4b)

res4 <- mod_results(m4b, mod = "PC_type", data = dat4, group = "Study_ID")

fig.4d <- orchard_plot(res4, mod = "PC_type", group = "Study_ID", data = dat4, xlab = "Correlation (r)", alpha=0.4, transfm = "tanh")+ ylim(-1,1) +
  theme(axis.text.y = element_text(angle = 45)) +
  ggtitle('Post-copulatory traits within external fertilisers') +
    geom_signif(comparisons = list(c("Seminal fluid quantity", "Total ejaculate size", "Sperm normality", "Sperm velocity", "Sperm length", "Sperm number")),
              annotations = "*")

```

#### Fig. 4
```{r,}

fig.4 <- ((fig.4a + fig.4b)/(fig.4c + fig.4d)) + plot_annotation(tag_levels = 'A')
fig.4
```


### Trait variation cause

```{r, message = FALSE}

dat$PC_variation_cause2<-as.factor(dat$PC_variation_cause2)

levels(dat$PC_variation_cause2) <- list("natural" = "1", "environmental plasticity" = "2", "age" = "3", "direct manipulation" = "4", "genetic variation" = "5", "unclear/other" = "6")


m2 <- rma.mv(yi = yi, V = VCV, mod = ~PC_variation_cause2-1,  
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             test = "t",
             data = dat)

summary(m2)

r2_ml(m2)
```

#### Fig. 5

```{r,}

res5 <- mod_results(m2, mod = "PC_variation_cause2", data = dat, group = "Study_ID")

fig.5 <- orchard_plot(res5, mod = "PC_variation_cause2", group = "Study_ID", data = dat, xlab = "Correlation (r)", alpha=0.4, transfm = "tanh") +
  theme(axis.text.y = element_text(angle = 45)) +
  scale_colour_manual(values = c("grey34","grey34", "grey34","grey34", "grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34", "grey34","grey34", "grey34","grey34"))  +
  theme(axis.text.y = element_text(angle = 45)) +
    geom_signif(comparisons = list(c("Other", "Experimental selection", "Direct manipulation", "Age", "Environmental plasticity", "Natural")),
              annotations = "*")

fig.5
```


```{r,eval = FALSE}
### Competition order 
# dat$Competition_order<-as.factor(dat$Competition_order)
# 
# 
# levels(dat$Competition_order) <- list("P1" = "1", "P2" = "2", "Random mixing" = "3", "mating order controlled for" = "4")
# 
# m6 <- rma.mv(yi = yi, V = VCV, mod = ~Competition_order-1,  
#              random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat)
# 
# summary(m6)
# 
# r2_ml(m6)
# 
# 
# m6b <- rma.mv(yi = yi, V = vi, mod = ~Competition_order,  
#              random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat)
# 
# summary(m6b)
# 
# 
# fig.4d <- orchard_plot(m6, mod = "Competition_order", group = "Study_ID", data = dat, xlab = "zr", alpha=0.4) +
#   theme(axis.text.y = element_text(angle = 45)) +
#   scale_colour_manual(values = c("grey34","grey34", "grey34","grey34")) +
#   scale_fill_manual(values=c("grey34","grey34", "grey34","grey34"))  +
#   theme(axis.text.y = element_text(angle = 45)) +
#     geom_signif(comparisons = list(c("P1", "P2", "Random mixing", "Mating order controlled for")),annotations = "*")
# 
# fig.4d
```


```{r, eval = FALSE}
#have grouped p1 and p2 because both are assumed to be loaded raffles. Does this make sense or will different traits potentially be important for offence/defense?

# dat5 <- subset(dat, Competition_order  == "P1")
# 
# dat5$PC_type<-as.factor(dat5$PC_type)
# 
# VCV5 <- impute_covariance_matrix(vi = dat5$vi, cluster = dat5$Study_ID, r = 0.5)
# 
# levels(dat5$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7", "accessory gland size" = "8")
# 
# 
# m6a <- rma.mv(yi = yi, V = VCV5, mod = ~PC_type-1,  
#               random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat5)
# 
# summary(m6a)
# r2_ml(m6a)
# 
# 
# fig.S3a <- orchard_plot(m6a, mod = "PC_type", group = "Study_ID", data = dat5, xlab = "zr", alpha=0.4)+
#   theme(axis.text.y = element_text(angle = 45)) 

```


```{r, eval = FALSE}
#have grouped p1 and p2 because both are assumed to be loaded raffles. Does this make sense or will different traits potentially be important for offence/defense?

# dat6 <- subset(dat, Competition_order  == "P2")
# 
# dat6$PC_type<-as.factor(dat6$PC_type)
# 
# dat6 <- subset(dat6, PC_type %in% c("1", "3", "6", "7"))
# 
# levels(dat6$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "total ejaculate size" = "6", "seminal fluid quantity" = "7")
# 
# VCV6 <- impute_covariance_matrix(vi = dat6$vi, cluster = dat6$Study_ID, r = 0.5)
# 
# 
# 
# S3b <- rma.mv(yi = yi, V = VCV6, mod = ~PC_type-1,  
#               random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat6)
# 
# summary(S3b)
# r2_ml(S3b)
# 
# 
# fig.S3b <- orchard_plot(S3b, mod = "PC_type", group = "Study_ID", data = dat6, xlab = "zr", alpha=0.4)+
#   theme(axis.text.y = element_text(angle = 45)) 

```


```{r, eval = FALSE}
#have grouped p1 and p2 because both are assumed to be loaded raffles. Does this make sense or will different traits potentially be important for offence/defense?

# dat7 <- subset(dat, Competition_order  %in% c("P1", "P2"))
# 
# dat7$PC_type<-as.factor(dat7$PC_type)
# 
# dat7 <- subset(dat7, PC_type %in% c("1", "3", "6", "7"))
# 
# VCV7 <- impute_covariance_matrix(vi = dat7$vi, cluster = dat7$Study_ID, r = 0.5)
# 
# levels(dat7$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "total ejaculate size" = "6", "seminal fluid quantity" = "7")
# 
# 
# m6c <- rma.mv(yi = yi, V = VCV7, mod = ~PC_type-1,  
#               random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat7)
# 
# summary(m6c)
# r2_ml(m6c)
# 
# 
# fig.6a<- orchard_plot(m6c, mod = "PC_type", group = "Study_ID", data = dat7, xlab = "zr", alpha=0.4)+
#   theme(axis.text.y = element_text(angle = 45)) 

```


```{r, eval = FALSE}

# dat8 <- subset(dat, Competition_order == "Random mixing")
# 
# dat8$PC_type<-as.factor(dat8$PC_type)
# 
# VCV8 <- impute_covariance_matrix(vi = dat8$vi, cluster = dat8$Study_ID, r = 0.5)
# 
# levels(dat8$PC_type) <- list("sperm number" = "1", "sperm length" = "3", "sperm velocity" = "4", "sperm normality" = "5", "total ejaculate size" = "6", "seminal fluid quantity" = "7", "accessory gland size" = "8")
# 
# 
# m6b <- rma.mv(yi = yi, V = VCV8, mod = ~PC_type-1,  
#               random = list(~1|Study_ID,
#                           ~1|Effectsize_ID,
#                           ~1|Species,
#                          ~1|Phylogeny),
#              R=list(Phylogeny = VCV_species),
#              test = "t",
#              data = dat8)
# 
# summary(m6b)
# r2_ml(m6b)

# fig.6b <- orchard_plot(m6b, mod = "PC_type", group = "Study_ID", data = dat8, xlab = "zr", alpha=0.4)+
#   theme(axis.text.y = element_text(angle = 45)) 

```

## Publication bias and sensitvity analysis

### Multi-moderator model
```{r}

dat_fm <- subset(dat, PC_type !=2)

VCV_fm <- impute_covariance_matrix(vi = dat_fm$vi, cluster = dat_fm$Study_ID, r = 0.5)

mod_fm <- rma.mv(yi = yi, V = VCV_fm, mod = ~PC_type-1 + Fertilisation_mode + PC_variation_cause2,  
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             test = "t",
             data = dat_fm)
# 
# summary(mod_fm)
# 
# r2_ml(mod_fm)

res_fm <- dredge(mod_fm, trace = 2)

res_fm2 <- subset(res_fm, delta <= 4, recalc.weights = FALSE)
sw(res_fm2)
```


### Funnel plots
```{r}

# funnel plot
funnel(m0, xlab = "Zr", ylab = "Standard Eror")

# funnel plot on full model 
funnel(mod_fm, xlab = "Zr", ylab = "Standard Eror")

#I've added the full model - it looks a bit strange

```

### Small-study and decline effects 

```{r}

# small study effect
dat$sei <- sqrt(dat$vi)
egger <- rma.mv(yi = yi, V = VCV, 
             mod = sei,
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             data = dat)

# no statistical evidence for small-study effect
summary(egger)

#TODO - shinichi - why this does not work
bubble_plot(egger, mod = "sei", group = "Study_ID", data = dat)

# decline effect
dat$cYear <- scale(dat$Year_published, center = TRUE, scale = FALSE)
decline <- rma.mv(yi = yi, V = VCV, 
             mod = cYear,
             random = list(~1|Study_ID,
                          ~1|Effectsize_ID,
                          ~1|Species,
                         ~1|Phylogeny),
             R=list(Phylogeny = VCV_species),
             data = dat)

# no statistical evidence for decline effect
summary(decline)

# TODO this does not work - will get this working 
mod_results(decline, mod = "cYear", group = "Study_ID", data = dat)
bubble_plot(decline, mod = "cYear", group = "Study_ID", data = dat)

```

### Leave-one-group-out

```{r}

dat <- dat %>%
    mutate(leave_out = paste(First_author, Year_published, sep = "_"))
dat$leave_out <- as.factor(dat$leave_out)
dat$Year_published <- as.integer(dat$Year_published)

dat$Study_ID <- as.factor(dat$Study_ID)

LeaveOneOut_effectsize <- list()
for (i in 1:length(levels(dat$leave_out))) {
    d <- dat %>%
        filter(leave_out != levels(dat$leave_out)[i])

    VCV_leaveout <- impute_covariance_matrix(vi = d$vi, cluster = d$Study_ID, r = 0.5)

    LeaveOneOut_effectsize[[i]] <- rma.mv(yi = yi, V = VCV_leaveout, random = list(~1 |
        Study_ID, ~1 | Effectsize_ID, ~1| Species), method = "REML", data = d[d$leave_out !=
        levels(d$leave_out)[i], ])
}

# writing function for extracting est, ci.lb, and ci.ub from all models
est.func <- function(m0) {
    df <- data.frame(est = m0$yi, lower = m0$ci.lb, upper = m0$ci.ub)
    return(df)
}

# using dplyr to form data frame
MA_CVR <- lapply(LeaveOneOut_effectsize, function(x) est.func(x)) %>%
    bind_rows %>%
    mutate(left_out = levels(dat$leave_out))

#TODO why isn't this working??

```

```{r}

# telling ggplot to stop reordering factors
MA_CVR$left_out <- as.factor(MA_CVR$left_out)
MA_CVR$left_out <- factor(MA_CVR$left_out, levels = MA_CVR$left_out)

# plotting
leaveoneout <- ggplot(MA_CVR) + geom_hline(yintercept = 0, lty = 2, lwd = 1) +
    geom_hline(yintercept = m0$ci.lb, lty = 3, lwd = 0.75, colour = "black") +
    geom_hline(yintercept = m0$b, lty = 1, lwd = 0.75, colour = "black") + geom_hline(yintercept = m0$ci.ub,
    lty = 3, lwd = 0.75, colour = "black") + geom_pointrange(aes(x = left_out, y = est,
    ymin = lower, ymax = upper)) + xlab("Study left out") + ylab("lnRR, 95% CI") +
    coord_flip() + theme(panel.grid.minor = element_blank()) + theme_bw() + theme(panel.grid.major = element_blank()) +
    theme(panel.grid.minor.x = element_blank()) + theme(axis.text.y = element_text(size = 6))

leaveoneout

```